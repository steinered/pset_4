---
title: "pset4_steiner"
author: "erika steiner"
date: "`r Sys.Date()`"
output: html_document
editor_options: 
  markdown: 
    wrap: 72
---

In Lopez-Osorio et al (2017), posted on Canvas, the authors undertake an
exploratory study. They ask what sort of factors relating to incidents
of reported domestic violence (DV), and the parties involved, can
predict DV recidivism, where DV recidivism is defined as one or more
repeat calls to the police within six months. Although they test 66
candidate predictors (by my count), they take no account of multiple
testing. Here you re-analyze their results, employing methods to control
both FWER and FDR.

```{r setup, include = FALSE}
# load packages

library("tidyverse")
library("magrittr")
library("knitr")
library("kableExtra")
library("pdftools")
library("stringr")
# library("fixest")
# library("broom")
# library("did")
# library("plm")
#
# library("stargazer")
# library("ivreg")

# get rid of scientific notation
options(scipen=999)

# don't print code
knitr::opts_chunk$set(echo = FALSE)
```

1\. Extract data from Tables 1 through 4 of the article, constructing a
dataset or dataframe that can be analyzed with a statistical package.

```{r extract data}
# in another life, i do this by coding
# but today, i use tabula
```

```{r create table 1}
# instructions source: https://crimebythenumbers.com/scrape-table.html

# make pdf text file
pdf_text <- pdf_text(
  # file path
  "lopez_osorio_etal_2017.pdf")

# extract table 1 on page 5
lotable1 <- pdf_text[[5]] %>% 
  # split table on line breaks
  str_split(., "\n", simplify = TRUE) %>% 
  trimws()

# clean up table
lotable1 <- 
  # select only rows with data
  lotable1[11:49] %>% 
  # and remove rows of over-wrapped indicator text, to be added manually later
  # ie only keep rows with numeric results
  keep( ~ str_detect(.x, "\\.\\d+")) %>% 
  # create columns
  str_split_fixed(., " {2,}", 7) %>% 
  # convert to data frame
  data.frame(.)

# add column names for easy reading

names(lotable1) <- c("Indicators",
                       "RR",
                       "X^2",
                       "Present",
                       "Absent",
                       "N/S",
                       "PerValid")

# separate RR coefficient from 95% CI
lotable1 %<>%
  mutate(CI = str_extract(RR, "(?<=\\[)[0-9.]+-[0-9.]+"),
         RR = str_extract(RR, "^[0-9.]+"))
  
# reorder so CI next to RR
lotable1 <-
  lotable1[, c("Indicators",
                 "RR",
                 "CI",
                 "X^2",
                 "Present",
                 "Absent",
                 "N/S",
                 "PerValid")]

```

```{r creating tables 2-4}
# extract table 2 on page 6
lotable2 <- pdf_text[[6]] %>% 
  # split table on line breaks
  str_split(., "\n", simplify = TRUE) %>% 
  trimws()

# clean up table
lotable2 <- 
  # select only rows with data
  lotable2[12:51] %>% 
  # and remove rows of over-wrapped indicator text, to be added manually later
  keep( ~ str_detect(.x, "\\.\\d+")) %>% 
  # create columns
  str_split_fixed(., " {2,}", 7) %>% 
  # convert to data frame
  data.frame(.)

# add column names for easy reading

names(lotable2) <- c("Indicators",
                       "RR",
                       "X^2",
                       "Present",
                       "Absent",
                       "N/S",
                       "PerValid")

# separate RR coefficient from 95% CI
lotable2 %<>%
  mutate(CI = str_extract(RR, "(?<=\\[)[0-9.]+-[0-9.]+"),
         RR = str_extract(RR, "^[0-9.]+"))
  
# reorder so CI next to RR
lotable2 <-
  lotable2[, c("Indicators",
                 "RR",
                 "CI",
                 "X^2",
                 "Present",
                 "Absent",
                 "N/S",
                 "PerValid")]

# repeat for table 3
# extract table 3 on page 7
lotable3 <- pdf_text[[7]] %>% 
  # split table on line breaks
  str_split(., "\n", simplify = TRUE) %>% 
  trimws()

# clean up table
lotable3 <- 
  # select only rows with data
  lotable3[11:41] %>% 
  # and remove rows of over-wrapped indicator text, to be added manually later
  keep( ~ str_detect(.x, "\\.\\d+")) %>% 
  # create columns
  str_split_fixed(., " {2,}", 7) %>% 
  # convert to data frame
  data.frame(.)

# add column names for easy reading

names(lotable3) <- c("Indicators",
                       "RR",
                       "X^2",
                       "Present",
                       "Absent",
                       "N/S",
                       "PerValid")

# separate RR coefficient from 95% CI
lotable3 %<>%
  mutate(CI = str_extract(RR, "(?<=\\[)[0-9.]+-[0-9.]+"),
         RR = str_extract(RR, "^[0-9.]+"))
  
# reorder so CI next to RR
lotable3 <-
  lotable3[, c("Indicators",
                 "RR",
                 "CI",
                 "X^2",
                 "Present",
                 "Absent",
                 "N/S",
                 "PerValid")]

# repeat for table 4
# extract table 4 on page 8
lotable4 <- pdf_text[[8]] %>% 
  # split table on line breaks
  str_split(., "\n", simplify = TRUE) %>% 
  trimws()

# clean up table
lotable4 <- 
  # select only rows with data
  lotable4[11:36] %>% 
  # and remove rows of over-wrapped indicator text, to be added manually later
  # ie only keep rows with numeric results
  keep( ~ str_detect(.x, "\\.\\d+")) %>% 
  # create columns
  str_split_fixed(., " {2,}", 7) %>% 
  # convert to data frame
  data.frame(.)

# add column names for easy reading

names(lotable4) <- c("Indicators",
                       "RR",
                       "X^2",
                       "Present",
                       "Absent",
                       "N/S",
                       "PerValid")

# separate RR coefficient from 95% CI
lotable4 %<>%
  mutate(CI = str_extract(RR, "(?<=\\[)[0-9.]+-[0-9.]+"),
         RR = str_extract(RR, "^[0-9.]+"))
  
# reorder so CI next to RR
lotable4 <-
  lotable4[, c("Indicators",
                 "RR",
                 "CI",
                 "X^2",
                 "Present",
                 "Absent",
                 "N/S",
                 "PerValid")]
```

```{r show tables}
lotable1 %>% 
  kable() %>% 
  kable_styling()
```



2\. The authors use chi-square statistics to test for association
between their candidate predictors and DV recidivism. On the basis of
the authors’ analysis, how many significant predictors are there at the
5 percent level?

3\. Obtain p-values associated with the chi-square statistics and plot
their distribution. Under the null hypothesis, one can show that
p-values are uniformly distributed. Given that, would you say the
predictors are basically all noise, or does the histogram suggest there
is some predictive signal among them?

4\. Construct Bonferroni p-values. Controlling the FWER at 5 percent,
which predictors are significant? Which predictors lose their
significance when you account for multiple testing using the Bonferroni
correction?

5\. Now test for significance using the Benjamini-Hochberg approach,
controlling the FDR at 5 percent. Produce a useful visualization that
illustrates how the procedure works. According to this criterion, how
many of the features are significant? In expectation, how many of these
are false discoveries?

6\. Compute the probability that each test represents a false discovery.
This requires solving one equation in one unknown for each test.

7\. Produce a concise listing of the predictors and the various test
results indicating which of them are significant according to the
various testing procedures. Also show which are not significant
according to any test. Do the most- or least-significant predictors
follow any pattern? What about those in between, i.e., those which are
significant according to some procedures but not others?

8\. Considering the objectives of the research study, which do you think
is the more appropriate approach to multiple testing, FWER control or
FDR control? Explain.

9\. It is a complete coincidence that the authors’ unadjusted testing
procedure and the Benjamini-Hochberg procedure produce similar numbers
of significant predictors. Can you explain why this is the case? Hint:
think about the graph you produced in question 5 and the listing you
produced in question 7.

10\. Does accounting for multiple testing lead you to draw different
conclusions than those of Lopez-Osorio et al regarding the factors that
predict DV recidivism? Explain.
